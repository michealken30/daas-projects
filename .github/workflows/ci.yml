name: Secure Loan Application CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  DOCKER_REGISTRY: docker.io/${{ secrets.DOCKERHUB_USERNAME }}
  ECR_REPOSITORY_GOV: government-api
  ECR_REPOSITORY_LOAN: loan-validator-portal
  MANIFEST_REPO: michealken30/loan-app-config
  COSIGN_EXPERIMENTAL: 1

jobs:
  # ==================== SAST Security Scanning ====================
  sast-scan:
    name: SAST Code Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: |
            p/security-audit
            p/golang
            p/docker
          severity: HIGH,CRITICAL

      - name: SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets._GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=daas-projects_daas-projects
            -Dsonar.projectName="daas-projects"
            -Dsonar.host.url=${{ secrets.SONAR_URL }}
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}
            -Dsonar.sources=general_info/projects/Project_Loan
            -Dsonar.branch.name=main
            -Dsonar.qualitygate.wait=true

  # ==================== Build & Scan Government API ====================
  build-government-api:
    name: Build & Scan Government API
    needs: sast-scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    outputs:
      image-tag: ${{ steps.image-info.outputs.tag }}
      image-digest: ${{ steps.push.outputs.digest }}
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set image tag
        id: image-info
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          IMAGE_TAG="${SHORT_SHA}-${{ github.run_number }}"
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Build Government API image
        working-directory: general_info/projects/Project_Loan/government_api/backend
        run: |
          docker build \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg VCS_REF=${{ github.sha }} \
            --build-arg VERSION=${{ env.IMAGE_TAG }} \
            -t ${{ env.DOCKER_REGISTRY }}/${{ env.ECR_REPOSITORY_GOV }}:${{ env.IMAGE_TAG }} \
            -f Dockerfile .

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_REGISTRY }}/${{ env.ECR_REPOSITORY_GOV }}:${{ env.IMAGE_TAG }}
          format: sarif
          output: trivy-government.sarif
          severity: CRITICAL,HIGH
          exit-code: 1

      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-government.sarif

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.DOCKER_REGISTRY }}/${{ env.ECR_REPOSITORY_GOV }}:${{ env.IMAGE_TAG }}
          format: spdx-json
          output-file: sbom-government.spdx.json

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Push image
        id: push
        run: |
          docker push ${{ env.DOCKER_REGISTRY }}/${{ env.ECR_REPOSITORY_GOV }}:${{ env.IMAGE_TAG }}
          echo "digest=$(docker inspect --format='{{index .RepoDigests 0}}' \
            ${{ env.DOCKER_REGISTRY }}/${{ env.ECR_REPOSITORY_GOV }}:${{ env.IMAGE_TAG }} | cut -d'@' -f2)" >> $GITHUB_OUTPUT

      - name: Sign image
        run: |
          cosign sign --yes \
            ${{ env.DOCKER_REGISTRY }}/${{ env.ECR_REPOSITORY_GOV }}@${{ steps.push.outputs.digest }}

      - name: Attach SBOM
        run: |
          cosign attach sbom \
            --sbom sbom-government.spdx.json \
            ${{ env.DOCKER_REGISTRY }}/${{ env.ECR_REPOSITORY_GOV }}@${{ steps.push.outputs.digest }}

  # ==================== Build & Scan Loan Validator ====================
  build-loan-validator:
    name: Build & Scan Loan Validator Portal
    needs: sast-scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    outputs:
      image-tag: ${{ steps.image-info.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set image tag
        id: image-info
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          IMAGE_TAG="${SHORT_SHA}-${{ github.run_number }}"
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Build Loan Validator image
        working-directory: general_info/projects/Project_Loan/loan_validator_portal/backend
        run: |
          docker build \
            -t ${{ env.DOCKER_REGISTRY }}/${{ env.ECR_REPOSITORY_LOAN }}:${{ env.IMAGE_TAG }} \
            -f Dockerfile .

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_REGISTRY }}/${{ env.ECR_REPOSITORY_LOAN }}:${{ env.IMAGE_TAG }}
          format: sarif
          output: trivy-loan.sarif
          severity: CRITICAL,HIGH
          exit-code: 1

      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-loan.sarif

  # ==================== Update Manifests (GitOps) ====================
  update-manifests:
    name: Update Manifests and Trigger GitOps
    needs: [build-government-api, build-loan-validator]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ env.MANIFEST_REPO }}
          token: ${{ secrets.MANIFEST_REPO_TOKEN }}
          path: manifests

      - name: Update Helm values
        working-directory: manifests
        run: |
          yq eval -i '.image.repository = "${{ env.DOCKER_REGISTRY }}/government-api"' helm/government-api/values.yaml
          yq eval -i '.image.tag = "${{ needs.build-government-api.outputs.image-tag }}"' helm/government-api/values.yaml

          yq eval -i '.image.repository = "${{ env.DOCKER_REGISTRY }}/loan-validator-portal"' helm/loan-validator-portal/values.yaml
          yq eval -i '.image.tag = "${{ needs.build-loan-validator.outputs.image-tag }}"' helm/loan-validator-portal/values.yaml

      - name: Commit changes
        working-directory: manifests
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git commit -am "Update images (Docker Hub)"
          git push

  # ==================== Deploy to Kind ====================
  deploy:
    name: Deploy to Kind
    needs: update-manifests
    runs-on: ubuntu-latest
    steps:
      - name: Load images into Kind
        run: |
          kind load docker-image \
            ${{ env.DOCKER_REGISTRY }}/${{ env.ECR_REPOSITORY_GOV }}:${{ needs.build-government-api.outputs.image-tag }}

          kind load docker-image \
            ${{ env.DOCKER_REGISTRY }}/${{ env.ECR_REPOSITORY_LOAN }}:${{ needs.build-loan-validator.outputs.image-tag }}

      - name: Verify deployments
        run: |
          kubectl rollout status deployment/government-api -n government-api
          kubectl rollout status deployment/loan-validator-portal -n loan-validator-portal
